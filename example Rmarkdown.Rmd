---
title: "Quality report for CosMx"
date: "`r Sys.Date()`"
author: "JiangLab"
output: 
  rmdformats::downcute:

params: 
  parameter1: "/fs/ess/PAS1475/Yuzhou_Chang/Jiang_Lab/Protocol_CosMX/CosMXQC/Data/BPC23NE_HTMA541_section9_3ugml_1"
  parameter2: "/fs/ess/PAS1475/Yuzhou_Chang/Jiang_Lab/Protocol_CosMX/CosMXQC/Data/BPC23NE_HTMA541_section9_3ugml_2"
  
---
```{css, echo = FALSE}
h1, h2, h3 {
  text-align: center;
}
p {
  font-size: 16px;
}

```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE, warning = FALSE)
```

```{r}
prep_file <- function(input_file = NULL,
                      exprMat_path = exprMat_path,
                      metadata_path = metadata_path,
                      tx_path = tx_path,
                      polygons_path = polygons_path,
                      positions_path = positions_path,
                      Log_path = Log_path){
  AllFiles <- list.files(path = input_file,pattern = ".csv")
  # grep all files 
  exprMat_name <- grep(pattern = "exprMat_file.csv",ignore.case = TRUE,value = TRUE,AllFiles)
  metadata_name <- grep(pattern = "metadata_file.csv", ignore.case = TRUE, value = TRUE,AllFiles)
  tx_name <- grep(pattern = "tx_file.csv", ignore.case = TRUE, value = TRUE,AllFiles)
  polygons_name <- grep(pattern = "polygons.csv", ignore.case = TRUE, value = TRUE,AllFiles)
  positions_name <- grep(pattern = "positions_file.csv",ignore.case = TRUE, value = TRUE,AllFiles)
  Log_name <- list.files(path = file.path(input_file,"Logs"),pattern = "fovs.csv")
  # Check existence of each file
  exprMat_path <- file.path(input_file,exprMat_name)
  metadata_path <- file.path(input_file,metadata_name)
  tx_path <- file.path(input_file,tx_name)
  polygons_path <- file.path(input_file,polygons_name)
  positions_path <- file.path(input_file,positions_name)
  Log_path <- file.path(input_file,"Logs/",Log_name)
  
  missing_files <- which(!file.exists(c(exprMat_path,
                                        metadata_path,
                                        tx_path,
                                        polygons_path,
                                        positions_path,
                                        Log_path)))
  
  if (length(missing_files) > 0) {
    cat("The following files are missing:\n")
    cat(paste(missing_files, collapse = "\n"))
    cat("\nPlease make sure all required files exist and try again.\n")
    # Halt execution
    q(save = "no",status = 1)
  }
  # Read data files
  exprMat_sub <- read.csv(exprMat_path)
  metadata_sub <- read.csv(metadata_path)
  tx_sub <- read.csv(tx_path)
  polygons_sub <- read.csv(polygons_path)
  positions <- read.csv(positions_path)
  log.file <- read.csv(Log_path)
  
  SlideIndex <- unique(metadata_sub$slide_ID)
  positions <- positions[positions$Slide==SlideIndex,]
  positions$fov <- positions$FOV
  log.file <- log.file[log.file$Slide ==SlideIndex,]
  # modify some qc and add order of FOV
  FOV.order <- log.file[,c("FOV","Order")]
  FOV.order$fov_order <- paste0("Fov:",FOV.order$FOV,"/","O:",FOV.order$Order)
  FOV.order$fov <- FOV.order$FOV
  metadata_sub <- left_join(metadata_sub,FOV.order,by = "fov")
  metadata_sub <- left_join(metadata_sub,positions[,c("fov", "X_mm","Y_mm")],by = "fov")
  tx_sub <- left_join(tx_sub,FOV.order,by = "fov")
  tx_sub <- left_join(tx_sub,positions[,c("fov", "X_mm","Y_mm")], by = "fov")
  tx_sub$fov_order <- factor(tx_sub$fov_order,levels = unique(tx_sub$fov_order[order(tx_sub$Order)]))
  metadata_sub$fov_order <- factor(metadata_sub$fov_order,levels = unique(metadata_sub$fov_order[order(metadata_sub$Order)]))
  
  combined_data <- list(
    exprMat_sub = exprMat_sub,
    metadata_sub = metadata_sub,
    tx_sub = tx_sub,
    polygons_sub = polygons_sub,
    positions = positions,
    log = log.file
  )
  return(combined_data)
}

global_summarize <- function(combined_data = combined_data){
  SlideIndex <- unique(combined_data$metadata_sub$slide_ID)
  RunName <- unique(combined_data$metadata_sub$Run_Tissue_name)
  CellNumberTotal <- nrow(combined_data$exprMat_sub)
  FOVNumberTotal <- length(unique(combined_data$exprMat_sub$fov))
  TranscriptsNumberTotal <- nrow(combined_data$tx_sub)
  UnassignedTranscriptsNumberTotal <- nrow(combined_data$tx_sub[combined_data$tx_sub$CellComp == "None",])
  CytoplasmTranscriptsNumberTotal <- nrow(combined_data$tx_sub[combined_data$tx_sub$CellComp == "Cytoplasm",])
  MembraneTranscriptsNumberTotal <- nrow(combined_data$tx_sub[combined_data$tx_sub$CellComp == "Membrane",])
  NuclearTranscriptsNumberTotal <- nrow(combined_data$tx_sub[combined_data$tx_sub$CellComp == "Nuclear",])
  res_out <- list(RunName,
               SlideIndex,
               FOVNumberTotal,
               CellNumberTotal,
               TranscriptsNumberTotal,
               UnassignedTranscriptsNumberTotal,
               CytoplasmTranscriptsNumberTotal,
               MembraneTranscriptsNumberTotal,
               NuclearTranscriptsNumberTotal)
  return(res_out)
}


GlobalViewTable_func <- function(Global_View = NULL){
  Global_View <- Global_View
  GlobalViewTable <- data.frame(Item = c("Run name",
                      "Slide Index",
                      "Total FOV number",
                      "Total Cell Number",
                      "Total Transcripts",
                      "Unassigned Transcripts",
                      "Cytoplasm Transcripts",
                      "Membrane Transcripts",
                      "Nuclear Transcripts"),
             Statistics = c(Global_View[[1]],
                            Global_View[[2]],
                            Global_View[[3]],
                            Global_View[[4]],
                            Global_View[[5]],
                            paste0(Global_View[[6]]," (",round(Global_View[[6]]/Global_View[[5]]*100,2),"%)"),
                            paste0(Global_View[[7]]," (",round(Global_View[[7]]/Global_View[[5]]*100,2),"%)"),
                            paste0(Global_View[[8]]," (",round(Global_View[[8]]/Global_View[[5]]*100,2),"%)"),
                            paste0(Global_View[[9]]," (",round(Global_View[[9]]/Global_View[[5]]*100,2),"%)"))
  )
  knitr::kable(GlobalViewTable, align = "cc")
}

# function for Profiling position and order (FOV number/ Order)
plt_pos_order <- function(combined_data = combined_data){
  p <- ggplot(combined_data$log, aes(x = X_mm, y = Y_mm)) +
    geom_point(shape = 22, size = 10, fill = "white") + # shape 22 is a square
    geom_text(aes(label = paste0(FOV,"/",Order)), vjust = 0, color = "black") +
    theme_classic() +
    labs(x = "X_mm", y = "Y_mm")
  # ggtitle("FOV position and profile order (FOV / Order)") + 
  # theme(plot.title = element_text(size = 20,hjust = 0.5))
  print(p)
}

# function for Total number of cells per FOV
plt_cellPerFov <- function(combined_data = combined_data){
  cell_counts_per_fov <- combined_data$metadata_sub %>%
    group_by(fov_order) %>%
    summarise(cell_count = n())
  
  p <- ggplot(cell_counts_per_fov, aes(x = fov_order,y = cell_count))+theme_minimal()+
    geom_col(width = 0.5*nrow(cell_counts_per_fov)/nrow(cell_counts_per_fov))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(cell_counts_per_fov$cell_count)+100)
  print(p)
}

# function for Total number of transcripts per FOV
plt_TranscriptsPerFov <- function(combined_data = combined_data){
  Transcripts_per_fov <- combined_data$tx_sub %>%
    group_by(fov_order) %>%
    summarise(cell_count = n())
  
  p <-  ggplot(Transcripts_per_fov, aes(x = fov_order,y = cell_count))+theme_minimal()+
    geom_col(width = 0.5*nrow(Transcripts_per_fov)/nrow(Transcripts_per_fov))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(Transcripts_per_fov$cell_count)+10000)
  print(p)
}

# function for Total number of unassigned transcripts per FOV
plt_UnassignedPerFOV <- function(combined_data = combined_data){
  UnassignTranscripts_per_fov <- combined_data$tx_sub %>%
    filter(cell_ID==0)%>%
    group_by(fov_order) %>%
    filter (CellComp =="None") %>%
    summarise(CellComp = n())
  
  p <-ggplot(UnassignTranscripts_per_fov, aes(x = fov_order,y = CellComp))+theme_minimal()+
    geom_col(width = 0.5*nrow(UnassignTranscripts_per_fov)/nrow(UnassignTranscripts_per_fov))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(UnassignTranscripts_per_fov$CellComp)+10000) + labs(y = "Unassigned Transcripts")
  print(p)
}

# Total number of nuclear transcripts per FOV
plt_NuclearPerFOV <- function(combined_data = combined_data){
  NuclearTranscripts_per_fov <- combined_data$tx_sub %>%
    filter(cell_ID!=0)%>%
    group_by(fov_order) %>%
    filter (CellComp =="Nuclear") %>%
    summarise(CellComp = n())
  
  p <- ggplot(NuclearTranscripts_per_fov, aes(x = fov_order,y = CellComp))+theme_minimal()+
    geom_col(width = 0.5*nrow(NuclearTranscripts_per_fov)/nrow(NuclearTranscripts_per_fov))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(NuclearTranscripts_per_fov$CellComp)+10000) + labs(y = "Nuclear Transcripts")
  print(p)
  
}

# Total number of membrane transcripts per FOV
plt_MembraneTranscriptsPerFOV <- function(combined_data = combined_data){
  MembraneTranscripts_per_fov <- combined_data$tx_sub %>% 
    filter(cell_ID!=0)%>%
    group_by(fov_order) %>%
    filter (CellComp =="Membrane") %>%
    summarise(CellComp = n())
  
  p <- ggplot(MembraneTranscripts_per_fov, aes(x = fov_order,y = CellComp))+theme_minimal()+
    geom_col(width = 0.5*nrow(MembraneTranscripts_per_fov)/nrow(MembraneTranscripts_per_fov))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(MembraneTranscripts_per_fov$CellComp)+10000) + labs(y = "Membrane Transcripts")
  print(p)
}

# Total number of cytoplasm transcripts per FOV
plt_CytoplasmTranscriptsPerFov <- function(combined_data = combined_data){
  CytoplasmTranscripts_per_fov <- combined_data$tx_sub %>%
    group_by(fov_order) %>%
    filter (CellComp =="Cytoplasm") %>%
    summarise(CellComp = n())
  
  p <- ggplot(CytoplasmTranscripts_per_fov, aes(x = fov_order,y = CellComp))+theme_minimal()+
    geom_col(width = 0.5*nrow(CytoplasmTranscripts_per_fov)/nrow(CytoplasmTranscripts_per_fov))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(CytoplasmTranscripts_per_fov$CellComp)+10000) + labs(y = "Cytoplasm Transcripts")
  print(p)
}

## calculate cell summary
Summarize_CellComp <- function( combined_data = combined_data){
  # Calculate the count of transcripts in each localization for each cell
  localization_counts <- combined_data$tx_sub %>%
    group_by(cell,cell_ID, fov_order, CellComp,X_mm, Y_mm) %>%
    summarize(count = n()) %>%
    ungroup()
  
  # Calculate the total number of transcripts per cell
  total_transcripts_per_cell <- combined_data$tx_sub %>%
    group_by(cell,cell_ID, fov_order,X_mm, Y_mm) %>%
    summarize(total_transcripts = n()) %>%
    ungroup()
  
  # Merge the total counts with the localization counts
  merged_data <- merge(localization_counts, total_transcripts_per_cell, 
                       by = c("cell","cell_ID", "fov_order","X_mm", "Y_mm"))
  
  # Calculate the proportion for each localization
  merged_data <- merged_data %>%
    mutate(proportion = round(count / total_transcripts * 100,2))
  
  # Pivot the data to have a wide format, showing both count and proportion for each localization
  cell_comp_summary <- merged_data %>%
    pivot_wider(names_from = CellComp, 
                values_from = c(count, proportion), 
                names_sep = "_", 
                values_fill = list(count = 0, proportion = 0))
  return(cell_comp_summary)
}


## Transcripts (percentage) per cell per FOV

plt_TranscriptsPerCellPerFOVPct <- function(cell_comp_summary = cell_comp_summary){
  cell_comp_summary <- cell_comp_summary
  
  # plot
  p0 <- ggplot(cell_comp_summary, aes(x = fov_order,y = proportion_None))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, 100)+labs(y = "Unassigned RNA (%)")+theme(axis.title.x=element_blank(),
                                                      axis.text.x=element_blank())
  
  p1 <- ggplot(cell_comp_summary, aes(x = fov_order,y = proportion_Membrane))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, 100)+labs(y = "Membrane RNA (%)")+theme(axis.title.x=element_blank(),
                                                    axis.text.x=element_blank())
  
  p2 <- ggplot(cell_comp_summary, aes(x = fov_order,y = proportion_Nuclear))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, 100)+labs(y = "Nuclear RNA (%)")+theme(axis.title.x=element_blank(),
                                                   axis.text.x=element_blank())
  p3 <- ggplot(cell_comp_summary, aes(x = fov_order,y = proportion_Cytoplasm))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, 100)+labs(y = "Cytoplasm RNA (%)")
  psum <- ggpubr::ggarrange(p0,p1,p2,p3,ncol = 1,heights = c(3,3, 3,5))
  print(psum)
}

## Transcripts (count) per cell per FOV
plt_TranscriptsPerCellPerFOVCt <- function(cell_comp_summary = cell_comp_summary){
  cell_comp_summary <- cell_comp_summary
  
  # plot 
  p0 <- ggplot(cell_comp_summary, aes(x = fov_order,y = count_None ))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(cell_comp_summary$count_None))+labs(y = "Unassigned RNA")+theme(axis.title.x=element_blank(),
                                                                                axis.text.x=element_blank())
  
  p1 <- ggplot(cell_comp_summary, aes(x = fov_order,y = count_Membrane))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(cell_comp_summary$count_Membrane))+labs(y = "Membrane RNA")+theme(axis.title.x=element_blank(),
                                                                                  axis.text.x=element_blank())
  
  p2 <- ggplot(cell_comp_summary, aes(x = fov_order,y = count_Nuclear))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(cell_comp_summary$count_Nuclear))+labs(y = "Nuclear RNA")+theme(axis.title.x=element_blank(),
                                                                                axis.text.x=element_blank())
  p3 <- ggplot(cell_comp_summary, aes(x = fov_order,y = count_Cytoplasm))+theme_minimal()+
    geom_boxplot(width=0.5*length(unique(cell_comp_summary$fov_order))/length(unique(cell_comp_summary$fov_order)))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(cell_comp_summary$count_Cytoplasm))+labs(y = "Cytoplasm RNA")
  psum <- ggpubr::ggarrange(p0,p1,p2,p3,ncol = 1,heights = c(3,3, 3,5))
  print(psum)
}

## Negative probe per FOV

plt_NegativeProbePerFov <- function(combined_data = combined_data){
  NegativeProbeName <- unique(grep("Nega",(combined_data$tx_sub$target),value = T))
  NegativeProbePerFOV <- combined_data$tx_sub %>%
    filter(target %in% NegativeProbeName) %>%
    group_by(fov_order) %>%
    summarize(NegativeProbeCounts = n()) %>%
    ungroup()
  
  p <- ggplot(NegativeProbePerFOV, aes(x = fov_order,y = NegativeProbeCounts))+theme_minimal()+
    geom_col(width = 0.5*nrow(NegativeProbePerFOV)/nrow(NegativeProbePerFOV))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(NegativeProbePerFOV$NegativeProbeCounts)+100) + labs(y = "Negative Probe counts")  
  print(p)
}

## 
## The number of negative probe in unassigned transcripts per FOV

plt_UnassignedNegativeProbePerFov <- function(combined_data = combined_data){
  NegativeProbeName <- unique(grep("Nega",(combined_data$tx_sub$target),value = T))
  NegativeProbePerCellPerFOV <- combined_data$tx_sub %>%
    filter(cell_ID == 0) %>%
    filter(target %in% NegativeProbeName) %>%
    group_by(cell,fov_order) %>%
    summarize(NegativeProbeCounts = n()) %>%
    ungroup()
  
  p <- ggplot(NegativeProbePerCellPerFOV, aes(x = fov_order,y = NegativeProbeCounts))+theme_minimal()+
    geom_col(width = 0.5*nrow(NegativeProbePerCellPerFOV)/nrow(NegativeProbePerCellPerFOV))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(NegativeProbePerCellPerFOV$NegativeProbeCounts)+0.1*max(NegativeProbePerCellPerFOV$NegativeProbeCounts)) + labs(y = "Negative Probe counts")
  print(p)
}


# Negative probe per cell per FOV 

plt_NegativeProbePerCellPerFov <- function(combined_data = combined_data){
  NegativeProbeName <- unique(grep("Nega",(combined_data$tx_sub$target),value = T))
  
  df <- combined_data$tx_sub %>%
    mutate(NegativeProbe_expressed = ifelse(target %in% NegativeProbeName, 1, 0))
  
  # Step 2: Summarize the data to count the cells
  # Count the number of cells expressing TPI1 and IGFBP7
  expression_counts <- df %>%
    filter(cell_ID != 0) %>%
    group_by(cell, fov_order) %>%
    summarize(Negative_expressed = sum(NegativeProbe_expressed)) %>%
    ungroup()
  
  p <- ggplot(expression_counts, aes(x = fov_order,y = Negative_expressed))+theme_minimal()+
    geom_boxplot(width = 0.5*nrow(expression_counts)/nrow(expression_counts))+ theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    ylim(0, max(expression_counts$Negative_expressed)+0.1*max(expression_counts$Negative_expressed)) + labs(y = "Negative Probe counts")
  print(p)
}

## Overall transcripts 2D density plot for one slide of whole flowcell 
plt_DensityTranscripts <- function(combined_data = combined_data){
  assigned_tx_sub <- combined_data$tx_sub
  p <- ggplot(assigned_tx_sub, aes(x=x_global_px, y=y_global_px)) +
    geom_bin2d(bins = 700) +
    scale_fill_continuous(type = "viridis") +
    scale_y_reverse() +
    theme_bw()+
    theme(
      legend.position='none'
    )+
    labs(x = "X Global Position (px)", y = "Y Global Position (px)", 
         title = "Density of All Transcripts in 2D Space") 
  print(p)
}

## Assigned transcripts 2D density plot for one slide of whole flowcell


plt_DensityAssignedTranscripts <- function(combined_data = combined_data){
  assigned_tx_sub <- combined_data$tx_sub %>%
    filter(cell_ID!=0)
  
  p <- ggplot(assigned_tx_sub, aes(x=x_global_px, y=y_global_px)) +
    geom_bin2d(bins = 700) +
    scale_fill_continuous(type = "viridis") +
    scale_y_reverse() +
    theme_bw()+
    theme(
      legend.position='none'
    )+
    labs(x = "X Global Position (px)", y = "Y Global Position (px)", 
         title = "Density of Assigned Transcripts in 2D Space") 
  print(p)
}

## Unassigned transcripts 2D density plot for one slide of whole flowcell

plt_DensityUnassignedTranscripts <- function(combined_data = combined_data){
  unassigned_tx_sub <- combined_data$tx_sub %>%
    filter(cell_ID==0)
  
  p <- ggplot(unassigned_tx_sub , aes(x=x_global_px, y=y_global_px)) +
    geom_bin2d(bins = 500) +
    scale_fill_continuous(type = "viridis") +
    theme_bw()+
    scale_y_reverse() +
    theme(
      legend.position='none'
    )+
    labs(x = "X Global Position (px)", y = "Y Global Position (px)",  title = "Density of Unassigned Transcripts in 2D Space") 
  print(p)
}


```

```{r FindFillName}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggpubr)
library(downloadthis)
# library("preload_functions.R")
input_fileone = params$parameter1
input_filetwo = params$parameter2
# input_file <- "/bmbl_data/yuzhou/collaborative/Sizun_lab/Protocol_CosMX/CosMX_test/"
# list all files



combined_data_one <- prep_file(input_file = input_fileone,
                           exprMat_path = exprMat_path,
                           metadata_path = metadata_path,
                           tx_path =tx_path ,
                           polygons_path = polygons_path,
                           positions_path = positions_path,
                           Log_path = Log_path
                            )

combined_data_two <- prep_file(input_file = input_filetwo,
                           exprMat_path = exprMat_path,
                           metadata_path = metadata_path,
                           tx_path =tx_path ,
                           polygons_path = polygons_path,
                           positions_path = positions_path,
                           Log_path = Log_path
                            )

Global_View_runone <- global_summarize(combined_data = combined_data_one)
Global_View_runtwo <- global_summarize(combined_data = combined_data_two)
```
## CosMX introduction
CosMx SMI is currently the only spatial platform enabling the quantification of 1000+ targets at subcellular resolution for maximum biological insight. The CosMx SMI in-situ chemistry is designed to enable high-plex and high-resolution with probes and fluorophores designed to reduce optical crowding limitations, allowing multiplexing probes to 1000 unique transcript species and beyond. In addition to high-plex, CosMx SMI also achieves high resolution. Target localization accuracy of ∼50 nm in the XY plane allows for targeting of <1kb transcripts with no loss in performance.

##  Global-View Of Entire Run {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`

```{r}
GlobalViewTable_func(Global_View = Global_View_runone)
```

### `r Global_View_runtwo[[1]]`

```{r}
GlobalViewTable_func(Global_View = Global_View_runtwo)
```

## Profiling position and order (FOV number/ Order) {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`

```{r}
plt_pos_order(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`

```{r}
plt_pos_order(combined_data = combined_data_two)
```

## Total number of cells per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`

```{r}
plt_cellPerFov(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`

```{r}
plt_cellPerFov(combined_data = combined_data_two)
```


## Total number of transcripts per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`

```{r}
plt_TranscriptsPerFov(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`

```{r}
plt_TranscriptsPerFov(combined_data = combined_data_two)
```

## Total number of unassigned transcripts per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_UnassignedPerFOV(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_UnassignedPerFOV(combined_data = combined_data_two)
```


## Total number of nuclear transcripts per FOV {.tabset .tabset-pills}
### `r Global_View_runone[[1]]`
```{r}
plt_NuclearPerFOV(combined_data = combined_data_one)
```


### `r Global_View_runtwo[[1]]`
```{r}
plt_NuclearPerFOV(combined_data = combined_data_two)
```

## Total number of membrane transcripts per FOV {.tabset .tabset-pills}
### `r Global_View_runone[[1]]`
```{r}
plt_MembraneTranscriptsPerFOV(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_MembraneTranscriptsPerFOV(combined_data = combined_data_two)
```

## Total number of membrane transcripts per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_MembraneTranscriptsPerFOV(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_MembraneTranscriptsPerFOV(combined_data = combined_data_two)
```

## Total number of cytoplasm transcripts per FOV {.tabset .tabset-pills}
### `r Global_View_runone[[1]]`
```{r}
plt_CytoplasmTranscriptsPerFov(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_CytoplasmTranscriptsPerFov(combined_data = combined_data_two)
```

## Transcripts (percentage) per cell per FOV {.tabset .tabset-pills}

Note: Unassigned transcripts panel (the first row) shows the "outlier cell", whose cell_ID is assigned as 0.
The data set can be downloaded for further exploration regarding transcript count and percentage per cell per FOV.

### `r Global_View_runone[[1]]`
```{r fig.height = 7}
Summarize_CellComp_one <- Summarize_CellComp(combined_data_one)
Summarize_CellComp_two <- Summarize_CellComp(combined_data_two)
plt_TranscriptsPerCellPerFOVPct(cell_comp_summary = Summarize_CellComp_one)
list(Summarize_CellComp_one) %>%  
  download_this(
    output_name = Global_View_runone[[1]],
    output_extension = ".xlsx",
    button_label = "Download datasets as xlsx",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
  
```

### `r Global_View_runtwo[[1]]`
```{r fig.height = 7}
plt_TranscriptsPerCellPerFOVPct(cell_comp_summary = Summarize_CellComp_two)
list(Summarize_CellComp_two) %>%  
  download_this(
    output_name = Global_View_runtwo[[1]],
    output_extension = ".xlsx",
    button_label = "Download datasets as xlsx",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```


## Transcripts (count) per cell per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r fig.height = 7}
plt_TranscriptsPerCellPerFOVCt(cell_comp_summary = Summarize_CellComp_one)
```

### `r Global_View_runtwo[[1]]`
```{r fig.height = 7}
plt_TranscriptsPerCellPerFOVCt(cell_comp_summary = Summarize_CellComp_two)
```


## Negative probe per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_NegativeProbePerFov(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_NegativeProbePerFov(combined_data = combined_data_two)
```

## The number of negative probe in unassigned transcripts per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_UnassignedNegativeProbePerFov(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_UnassignedNegativeProbePerFov(combined_data = combined_data_two)
```


## Negative probe per cell per FOV {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_NegativeProbePerCellPerFov(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_NegativeProbePerCellPerFov(combined_data = combined_data_two)
```


## Overall transcripts 2D density plot for one slide of whole flowcell {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r }
plt_DensityTranscripts(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r }
plt_DensityTranscripts(combined_data = combined_data_two)
```

## Assigned transcripts 2D density plot for one slide of whole flowcell {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_DensityAssignedTranscripts(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_DensityAssignedTranscripts(combined_data = combined_data_two)
```

## Unassigned transcripts 2D density plot for one slide of whole flowcell {.tabset .tabset-pills}

### `r Global_View_runone[[1]]`
```{r}
plt_DensityUnassignedTranscripts(combined_data = combined_data_one)
```

### `r Global_View_runtwo[[1]]`
```{r}
plt_DensityUnassignedTranscripts(combined_data = combined_data_two)
```
